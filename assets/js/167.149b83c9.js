(window.webpackJsonp=window.webpackJsonp||[]).push([[167],{520:function(t,s,a){"use strict";a.r(s);var _=a(44),e=Object(_.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"undo"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#undo"}},[t._v("#")]),t._v(" undo")]),t._v(" "),a("ul",[a("li",[t._v("[ ] 任务代码研究")])]),t._v(" "),a("h3",{attrs:{id:"activitytaskserviceimpl"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#activitytaskserviceimpl"}},[t._v("#")]),t._v(" ActivityTaskServiceImpl")]),t._v(" "),a("h4",{attrs:{id:"getuseractivitytasklist获取活动下用户任务列表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#getuseractivitytasklist获取活动下用户任务列表"}},[t._v("#")]),t._v(" getUserActivityTaskList获取活动下用户任务列表")]),t._v(" "),a("ol",[a("li",[t._v("根据"),a("code",[t._v("activityId")]),t._v("从缓存获取，获取不到从"),a("code",[t._v("mysql")]),t._v("获取")])]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v("\n\tt_task"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" taskId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tt_task"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("title "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" taskTitle"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tt_task"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CODE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tt_task"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rule_desc "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" ruleDesc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tt_task"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("condition_num "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" conditionNum"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tt_task"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("outside "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" taskOutside"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tt_biz_task"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("icon "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" taskIcon"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tt_biz_task"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("must_do "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" mustDo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tt_biz_task"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("jump_url "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" jumpUrl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tt_biz_task"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("finish_astrict "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" finishAstrict"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tt_biz_task"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sort "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" sort \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v("\n\tt_biz_task\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("LEFT")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("JOIN")]),t._v(" t_task "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ON")]),t._v(" t_biz_task"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("task_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" t_task"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v("\n\tt_biz_task"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("biz_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'1296017472897449986'")]),t._v(" \n\t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("AND")]),t._v(" t_biz_task"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ENABLE")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v("\n\tt_biz_task"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sort "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ASC")]),t._v("\n")])])]),a("ol",{attrs:{start:"2"}},[a("li",[t._v("写缓存")]),t._v(" "),a("li",[t._v("如果上传了"),a("code",[t._v("userId")]),t._v("，去缓存获取用户状态，任务的状态（用户任务领取状态 0未开始、1进行中、2任务已完成、3领取奖励完成）")]),t._v(" "),a("li",[t._v("缓存获取不到状态的任务，去mysql查询")])]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("t_user_task"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v(" \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v("\n\tuser_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'4ab5d7f8-1da7-4869-b707-4ab62a913c2f'")]),t._v(" \n\t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("AND")]),t._v(" biz_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'1296017472897449986'")]),t._v(" \n\t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("AND")]),t._v(" task_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'1006'")]),t._v("\n")])])]),a("ol",{attrs:{start:"5"}},[a("li",[t._v("写缓存")]),t._v(" "),a("li",[t._v("每日限制任务，通过查询当日完成次数，判断任务状态。查询缓存判断")])]),t._v(" "),a("h4",{attrs:{id:"getactivitytaskinfo-获取活动下任务详情"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#getactivitytaskinfo-获取活动下任务详情"}},[t._v("#")]),t._v(" getActivityTaskInfo（获取活动下任务详情）")]),t._v(" "),a("ol",[a("li",[t._v("优先从缓存获取")]),t._v(" "),a("li",[t._v("没有则从"),a("a",{attrs:{href:"#getTaskInfo%EF%BC%88%E4%BB%8Emysql%E5%8F%96%E4%BB%BB%E5%8A%A1%E8%AF%A6%E6%83%85%EF%BC%89"}},[t._v("mysql获取")]),t._v("，存到缓存。任务详情中包含'奖励：（ID=个数）形如：奖品ID1=10,奖品ID2=20',")]),t._v(" "),a("li",[t._v("获取用户任务状态（缓存）")]),t._v(" "),a("li",[t._v("获取完成任务人数（缓存）")]),t._v(" "),a("li",[t._v("获取完成任务人员列表（缓存）")])]),t._v(" "),a("h4",{attrs:{id:"gettaskinfo-从mysql取任务详情"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gettaskinfo-从mysql取任务详情"}},[t._v("#")]),t._v(" getTaskInfo（从mysql取任务详情）")]),t._v(" "),a("ol",[a("li",[t._v("根据"),a("code",[t._v("taskId")]),t._v("从task表获取任务信息，从"),a("code",[t._v("biz_task")]),t._v("表获取任务配置")]),t._v(" "),a("li",[t._v("判断当前是否在任务开启时间内，是则开启任务")]),t._v(" "),a("li",[t._v("根据"),a("code",[t._v("prizes")]),t._v("字段（形如：奖品ID1=10，奖品ID2=20）获取奖品")])]),t._v(" "),a("h4",{attrs:{id:"taskstart-开始任务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#taskstart-开始任务"}},[t._v("#")]),t._v(" taskStart（开始任务）")]),t._v(" "),a("ol",[a("li",[a("a",{attrs:{href:"#taskCheck%EF%BC%88%E4%BB%BB%E5%8A%A1%E6%A0%A1%E9%AA%8C%EF%BC%89"}},[t._v("检验任务")])]),t._v(" "),a("li",[t._v("获取任务详情  "),a("code",[t._v("task")]),t._v("表")]),t._v(" "),a("li",[t._v("[校验任务完成频次](#checkTaskFinishAstrict（任务完成频次限制检查 接取任务时候判断用）)，完成次数不可超过限制")]),t._v(" "),a("li",[t._v("写入"),a("code",[t._v("user_task")]),t._v("表")]),t._v(" "),a("li",[t._v("更新缓存\n"),a("ol",[a("li",[t._v("用户与任务状态")]),t._v(" "),a("li",[t._v("完成任务人数以及列表")]),t._v(" "),a("li",[t._v("更新频率限制任务的完成次数")])])])]),t._v(" "),a("h4",{attrs:{id:"taskcheck-任务校验"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#taskcheck-任务校验"}},[t._v("#")]),t._v(" taskCheck（任务校验）")]),t._v(" "),a("p",[t._v("根据"),a("code",[t._v("biz_id")]),t._v("，"),a("code",[t._v("task_id")]),t._v("查询 "),a("code",[t._v("biz_task")]),t._v("表，判断任务是否存在，是否开启，是否结束")]),t._v(" "),a("h4",{attrs:{id:"checktaskfinishastrict-任务完成频次限制检查-接取任务时候判断用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#checktaskfinishastrict-任务完成频次限制检查-接取任务时候判断用"}},[t._v("#")]),t._v(" checkTaskFinishAstrict（任务完成频次限制检查 接取任务时候判断用）")]),t._v(" "),a("ol",[a("li",[t._v("任务限制（biz_task表"),a("code",[t._v("finishAstrict")]),t._v("字段）为空，只能完成一次")]),t._v(" "),a("li",[t._v("不为空，获取限制条件（Time=Num，例如DAY=1）。判断"),a("code",[t._v("user_task")]),t._v("表是否超过限制")])]),t._v(" "),a("h4",{attrs:{id:"editusertaskstatus-用户任务状态修改"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#editusertaskstatus-用户任务状态修改"}},[t._v("#")]),t._v(" editUserTaskStatus（用户任务状态修改）")]),t._v(" "),a("ol",[a("li",[t._v("更新任务状态，如果更新为已完成需要检验任务已领取")]),t._v(" "),a("li",[t._v("异步更新缓存")])]),t._v(" "),a("h4",{attrs:{id:"getusertask-获取用户任务信息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#getusertask-获取用户任务信息"}},[t._v("#")]),t._v(" getUserTask（获取用户任务信息）")]),t._v(" "),a("p",[a("code",[t._v("user_task")]),t._v("表获取")]),t._v(" "),a("h4",{attrs:{id:"checkinvite-检测是否可以好友助力-接取过一个任务就算不能助力"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#checkinvite-检测是否可以好友助力-接取过一个任务就算不能助力"}},[t._v("#")]),t._v(" checkInvite（检测是否可以好友助力,接取过一个任务就算不能助力）")]),t._v(" "),a("p",[a("code",[t._v("user_task")]),t._v("有数据则为"),a("code",[t._v("false")])]),t._v(" "),a("h4",{attrs:{id:"gettaskspecialreward"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gettaskspecialreward"}},[t._v("#")]),t._v(" getTaskSpecialReward")]),t._v(" "),a("p",[t._v("根据"),a("code",[t._v("taskId")]),t._v("获取"),a("code",[t._v("prize")])]),t._v(" "),a("h4",{attrs:{id:"simpletask-简单任务-接取-完成-领奖一条龙"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#simpletask-简单任务-接取-完成-领奖一条龙"}},[t._v("#")]),t._v(" simpleTask（简单任务 接取-完成-领奖一条龙）")]),t._v(" "),a("ol",[a("li",[a("a",{attrs:{href:"#taskStart%EF%BC%88%E5%BC%80%E5%A7%8B%E4%BB%BB%E5%8A%A1%EF%BC%89"}},[t._v("接取任务")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#taskFinish%EF%BC%88%E7%94%A8%E6%88%B7%E5%AE%8C%E6%88%90%E4%BB%BB%E5%8A%A1%EF%BC%89"}},[t._v("完成任务")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#acceptPrize%EF%BC%88%E5%AE%8C%E6%88%90%E4%BB%BB%E5%8A%A1%E9%A2%86%E5%8F%96%E5%A5%96%E5%8A%B1%EF%BC%89"}},[t._v("领取奖励")])])]),t._v(" "),a("h4",{attrs:{id:"taskfinish-用户完成任务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#taskfinish-用户完成任务"}},[t._v("#")]),t._v(" taskFinish（用户完成任务）")]),t._v(" "),a("ol",[a("li",[t._v("校验任务")]),t._v(" "),a("li",[t._v("获取任务主体信息"),a("code",[t._v("task")]),t._v("表")]),t._v(" "),a("li",[t._v("判断是否是允许简单完成的任务，任务主体信息中的"),a("code",[t._v("code")]),t._v("是否包含在配置的简单任务中")]),t._v(" "),a("li",[a("a",{attrs:{href:"#editUserTaskStatus%EF%BC%88%E7%94%A8%E6%88%B7%E4%BB%BB%E5%8A%A1%E7%8A%B6%E6%80%81%E4%BF%AE%E6%94%B9%EF%BC%89"}},[t._v("编辑用户任务状态")])])]),t._v(" "),a("h4",{attrs:{id:"acceptprize-完成任务领取奖励"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#acceptprize-完成任务领取奖励"}},[t._v("#")]),t._v(" acceptPrize（完成任务领取奖励）")]),t._v(" "),a("ol",[a("li",[t._v("组装用户信息，从"),a("code",[t._v("cpdailyUserConsumer")]),t._v("获取")]),t._v(" "),a("li",[t._v("判断任务是否已经完成")]),t._v(" "),a("li",[t._v("完成任务领取奖励\n"),a("ol",[a("li",[t._v("抽奖机会奖励")]),t._v(" "),a("li",[t._v("商品奖励")]),t._v(" "),a("li",[t._v("道具奖励")]),t._v(" "),a("li",[t._v("票奖励")])])]),t._v(" "),a("li",[t._v("修改状态为已领奖")])]),t._v(" "),a("h4",{attrs:{id:"finishandacceptprize-完成任务并领取奖励-仅限内部调用-不提供前端方法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#finishandacceptprize-完成任务并领取奖励-仅限内部调用-不提供前端方法"}},[t._v("#")]),t._v(" finishAndAcceptPrize（完成任务并领取奖励，仅限内部调用，不提供前端方法）")]),t._v(" "),a("ol",[a("li",[t._v("校验任务")]),t._v(" "),a("li",[t._v("校验任务完成频次")]),t._v(" "),a("li",[t._v("获取任务主体信息")]),t._v(" "),a("li",[t._v("编辑用户任务状态")]),t._v(" "),a("li",[t._v("领取奖励")])]),t._v(" "),a("h4",{attrs:{id:"checkdraw-33天活动专用-检查抽奖机会"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#checkdraw-33天活动专用-检查抽奖机会"}},[t._v("#")]),t._v(" checkDraw（33天活动专用，检查抽奖机会）")]),t._v(" "),a("h2",{attrs:{id:"log"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#log"}},[t._v("#")]),t._v(" log")]),t._v(" "),a("ol",[a("li")])])}),[],!1,null,null,null);s.default=e.exports}}]);