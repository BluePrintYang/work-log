## log

1. [代理模式 (jdk动态代理 cglib)](https://mp.weixin.qq.com/s?__biz=MzU4ODI1MjA3NQ==&mid=2247506203&idx=2&sn=8c3b9e8c059359598eb7e7ea15ae9650&chksm=fddd0fdfcaaa86c9542780e326ef0a256740f87dd36f8e795b47852ca74b32131b710aa9132c&scene=21#wechat_redirect)



JDK代理要求被代理的类**必须实现接口**

而CGLIB动态代理则没有此类强制性要求。简单的说，`CGLIB`会让生成的代理类继承被代理类，并在代理类中对代理方法进行强化处理(前置处理、后置处理等)

如果委托类**被final修饰**，那么它不可被继承，即**不可被代理**；同样，如果委托类中存在final修饰的方法，那么该方法也不可被代理

### Fastclass机制

CGLIB采用了FastClass的机制来实现对被拦截方法的调用。

FastClass机制就是对一个类的方法建立索引，通过索引来直接调用相应的方法

**三种代理方式之间对比**

| 代理方式      | 实现                                                         | 优点                                                         | 缺点                                                         | 特点                                                         |
| :------------ | :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| JDK静态代理   | 代理类与委托类实现同一接口，并且在代理类中需要硬编码接口     | 实现简单，容易理解                                           | 代理类需要硬编码接口，在实际应用中可能会导致重复编码，浪费存储空间并且效率很低 | 好像没啥特点                                                 |
| JDK动态代理   | 代理类与委托类实现同一接口，主要是通过代理类实现InvocationHandler并重写`invoke`方法来进行动态代理的，在invoke方法中将对方法进行增强处理 | 不需要硬编码接口，代码复用率高                               | 只能够代理实现了接口的委托类                                 | 底层使用反射机制进行方法的调用                               |
| CGLIB动态代理 | 代理类将委托类作为自己的父类并为其中的非final委托方法创建两个方法，一个是与委托方法签名相同的方法，它在方法中会通过`super`调用委托方法；另一个是代理类独有的方法。在代理方法中，它会判断是否存在实现了`MethodInterceptor`接口的对象，若存在则将调用intercept方法对委托方法进行代理 | 可以在运行时对类或者是接口进行增强操作，且委托类无需实现接口 | 不能对`final`类以及final方法进行代理                         | **底层将方法全部存入一个数组中，通过数组索引直接进行方法调用** |

**CGlib比JDK快？**

- 使用CGLiB实现动态代理，CGLib底层采用ASM字节码生成框架，使用字节码技术生成代理类， 在jdk6之前比使用Java反射效率要高。唯一需要注意的是，CGLib不能对声明为final的方法进行代理， 因为CGLib原理是动态生成被代理类的子类。
- 在jdk6、jdk7、jdk8逐步对JDK动态代理优化之后，在调用次数较少的情况下，JDK代理效率高于CGLIB代理效率。只有当进行大量调用的时候，jdk6和jdk7比CGLIB代理效率低一点，但是到jdk8的时候，jdk代理效率高于CGLIB代理，总之，每一次jdk版本升级，jdk代理效率都得到提升，而CGLIB代理消息确有点跟不上步伐。

**Spring如何选择用JDK还是CGLIB？**

- 当Bean实现接口时，Spring就会用JDK的动态代理。
- 当Bean没有实现接口时，Spring使用CGlib实现。
- 可以强制使用CGlib



2. 讨论客户端服务端接口

## learn

### 每日一题



